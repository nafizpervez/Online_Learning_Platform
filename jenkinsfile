pipeline {
    agent any
    stages{
        stage('GIT CHECKOUT') {
                steps {
                    script {
                            sh "echo checkout begins......."

                            sh "apt-get install -y git"

                            git credentialsId: 'GIT_AUTH_TOKEN', url: 'https://github.com/nafizpervez/Online_Learning_Platform_BE_docker_python.git'
                            sh "ls -lart ./*" 
                            sh "git branch -a"
                            sh "git checkout master"

                            sh "echo checkout SUCCESSFUL"
                            }
                }
        }
        stage ('UNIT TEST'){
                steps {
                        sh "echo unit testing..."
                        sh '''
                            #!/bin/bash
                            umask 022
                            apt-get update
                            apt-get install -y python3
                            apt-get install -y python3-venv
                            python3 -m venv jenkins_venv
                            . ./jenkins_venv/bin/activate
                            pip install docker
                            echo "Cython<3" > cython_constraint.txt
                            PIP_CONSTRAINT=cython_constraint.txt pip install "ai-core-sdk[aicore-content]"
                            apt-get install -y postgresql
                            pip install -U psycopg2-binary
                            apt-get install -y libpq-dev python3-dev
                            pip install -U psycopg2
                            pip install -U sqlalchemy
                            pip install -U httpx 
                            pip install -U fastapi
                            pytest /usr/code/test/test_main.py

                            docker compose build
                        '''
                        sh "echo Test SUCCESSFULLY done"
                }
        }
    }
}